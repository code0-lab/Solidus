@if (isVisualSearchMode()) {
<!-- Visual Search Result View (System 1 Window Style) -->
<div class="modal-overlay">
  <div class="sys-window vs-window">
    <!-- Retro Header -->
    <div class="sys-window-header">
      <span class="sys-window-title">Visual Search Results</span>
      <button class="sys-button-small" (click)="closeVisualSearch()">✕</button>
    </div>

    <div class="vs-split-layout">
      <!-- Left Sidebar: Query Image -->
      <div class="vs-sidebar">
        <div class="vs-query-box">
          <img [src]="productService.queryImageUrl()" class="vs-query-img" alt="Search query">
        </div>
        <button class="sys-button-small"
          style="width: 100%; font-size: 11px; position: static; transform: none; margin-top: 5px;"
          (click)="undoCrop()">
          ⤺ UNDO CROP
        </button>

        <div class="vs-info-box">
          <div class="info-label">DETECTED CLASS</div>
          @if (selectedClusterId()) {
          <div class="info-value">#{{ selectedClusterId() }}</div>
          } @else {
          <div class="info-value">...</div>
          }
        </div>
      </div>

      <!-- Right Content: Results -->
      <div class="vs-content-area">
        @if (isClassifying()) {
        <div class="vs-status-msg">
          <p>Analyzing image pattern...</p>
          <div class="sys-progress-bar">
            <div class="sys-progress-fill"></div>
          </div>
        </div>
        } @else if (productService.products().length === 0) {
        <div class="vs-status-msg">
          <p>No matching items found in database.</p>
        </div>
        } @else {
        <div class="vs-grid">
          @for (product of productService.products(); track product.id) {
          <div class="vs-item-card" (click)="onSelectProduct(product)">
            <div class="vs-item-img-border">
              <img [src]="product.imageUrl" [alt]="product.name">
            </div>
            <div class="vs-item-details">
              <div class="vs-item-name">{{ product.name }}</div>
              <div class="vs-item-price">{{ product.price | currency }}</div>
            </div>
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
</div>
} @else {
<!-- Standard Search Page (Retro Style) -->
<div class="standard-search-container">
  <div class="sys-window standard-search-window">
    <div class="sys-window-header">
      <span class="sys-window-title">{{ productService.products().length > 0 ? 'SEARCH RESULTS' : 'SEARCH DATABASE'
        }}</span>
    </div>

    <div class="standard-search-content">
      @if (productService.products().length === 0) {
      <div class="retro-empty-state">
        <div class="sys-icon-large">?</div>
        <p>SYSTEM READY</p>
        <span class="retro-hint">ENTER KEYWORD OR SCAN IMAGE</span>
      </div>
      } @else {
      <app-product-list [products]="productService.products()" (selectProduct)="onSelectProduct($event)">
      </app-product-list>
      }
    </div>
  </div>
</div>
}

<!-- Cropper Modal (System 1 Window Style) -->
@if (showCropper()) {
<div class="modal-overlay">
  <div class="sys-window cropper-window">
    <div class="sys-window-header">
      <span class="sys-window-title">Crop Image</span>
      <button class="sys-button-small" (click)="cancelCrop()">✕</button>
    </div>

    <div class="cropper-content">
      <image-cropper [imageFile]="imageFile" [maintainAspectRatio]="false" [format]="'png'" [alignImage]="'center'"
        [roundCropper]="false" [allowMoveImage]="false" [backgroundColor]="'#808080'"
        style="max-height: 100%; max-width: 100%; width: 100%; height: 100%;" (imageCropped)="imageCropped($event)"
        (imageLoaded)="imageLoaded($event)" (cropperReady)="cropperReady()"
        (loadImageFailed)="loadImageFailed()"></image-cropper>
    </div>

    <div class="cropper-footer">
      <button class="sys-button" (click)="confirmCrop()">SEARCH</button>
    </div>
  </div>
</div>
}

<!-- Product Detail Modal (Global) -->
@if (selectedProduct()) {
<app-product-detail [product]="selectedProduct()!" (onClose)="closeProductDetail()">
</app-product-detail>
}