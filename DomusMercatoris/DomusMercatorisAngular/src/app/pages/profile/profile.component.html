<div class="profile-container">
  @if (authService.currentUser(); as user) {

  <!-- DESKTOP VIEW -->
  <div class="desktop-view">
    <h2>My Profile</h2>
    <div class="profile-layout">
      <!-- Sidebar Navigation -->
      <div class="profile-sidebar">
        <div class="user-brief">
          <div class="profile-avatar-container">
            @if (authService.currentUser()?.profilePictureUrl && !imageLoadFailed()) {
            <img [src]="authService.getProfileImageUrl(authService.currentUser()?.profilePictureUrl)" alt="Profile"
              class="profile-avatar" (error)="handleImageError()">
            } @else {
            <div class="profile-avatar-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
              </svg>
            </div>
            }
            <div class="avatar-overlay">
              <label for="avatar-input-desktop" class="change-avatar-btn">CHANGE</label>
            </div>
            <input type="file" id="avatar-input-desktop" (change)="onFileSelected($event)" accept="image/*"
              style="display: none;">
          </div>

          <div class="user-brief-info">
            <strong>{{ user.firstName }} {{ user.lastName }}</strong>
            <span>{{ user.email }}</span>
          </div>
        </div>

        <nav class="profile-nav">
          <button [class.active]="activeTab() === 'edit'" (click)="setActiveTab('edit')">
            Edit Profile
          </button>
          <button [class.active]="activeTab() === 'password'" (click)="setActiveTab('password')">
            Change Password
          </button>
          <button [class.active]="activeTab() === 'companies'" (click)="setActiveTab('companies')">
            My Companies
          </button>
          <button class="nav-logout" (click)="logout()">
            Log Out
          </button>
        </nav>
      </div>

      <!-- Main Content Area -->
      <div class="profile-content">

        <!-- Edit Profile Tab -->
        @if (activeTab() === 'edit') {
        <div class="tab-content fade-in">
          <h3>Edit Profile</h3>
          <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">

            <div class="form-row">
              <div class="field-group">
                <label for="firstName">First Name</label>
                <input id="firstName" type="text" formControlName="firstName">
              </div>
              <div class="field-group">
                <label for="lastName">Last Name</label>
                <input id="lastName" type="text" formControlName="lastName">
              </div>
            </div>

            <div class="field-group">
              <label for="email">Email Address</label>
              <input id="email" type="email" formControlName="email">
              @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
              <small class="error-msg">Please enter a valid email address.</small>
              }
            </div>

            <div class="field-group">
              <label for="phone">Phone</label>
              <input id="phone" type="tel" formControlName="phone" placeholder="Add your phone number">
              @if (profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched) {
              <small class="error-msg">Please enter a valid phone number (digits, space, +).</small>
              }
            </div>

            <div class="field-group">
              <label for="address">Address</label>
              <textarea id="address" rows="3" formControlName="address" placeholder="Add your address"></textarea>
            </div>

            <!-- Conditional Password Field if Email Changed -->
            @if (profileForm.value.email !== user.email) {
            <div class="field-group highlight-box">
              <label for="confirmPassEmail">Current Password (Required to change email)</label>
              <input id="confirmPassEmail" type="password" formControlName="currentPassword"
                placeholder="Confirm with your password">
            </div>
            }

            <button class="save-btn" type="submit" [disabled]="isSaving() || profileForm.invalid || !hasChanges">
              {{ isSaving() ? 'Saving...' : 'Save Changes' }}
            </button>
          </form>
        </div>
        }

        <!-- Change Password Tab -->
        @if (activeTab() === 'password') {
        <div class="tab-content fade-in">
          <h3>Change Password</h3>
          <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
            <div class="field-group">
              <label for="currentPass">Current Password</label>
              <input id="currentPass" type="password" formControlName="currentPassword">
            </div>

            <div class="field-group">
              <label for="newPass">New Password</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input id="newPassword" type="password" formControlName="newPassword" style="flex: 1;">
                <button type="button" (click)="generateRandomPassword()"
                  style="padding: 0.5rem; background: #333; color: white; border: none; cursor: pointer; font-size: 0.8rem;">Generate
                  Random</button>
              </div>
              @if (passwordForm.get('newPassword')?.errors?.['minlength'] &&
              passwordForm.get('newPassword')?.touched) {
              <small class="error-msg">Password must be at least {{ validationConstants.password.minLength }}
                characters.</small>
              }
              @if (passwordForm.get('newPassword')?.errors?.['pattern'] &&
              passwordForm.get('newPassword')?.touched) {
              <small class="error-msg">{{ validationConstants.password.errorMessage }}</small>
              }
            </div>

            <div class="field-group">
              <label for="confirmPass">Confirm New Password</label>
              <input id="confirmNewPassword" type="password" formControlName="confirmNewPassword">
              @if (passwordForm.errors?.['mismatch'] && passwordForm.get('confirmNewPassword')?.touched) {
              <small class="error-msg">Passwords do not match.</small>
              }
            </div>

            <button class="save-btn" type="submit" [disabled]="isSaving() || passwordForm.invalid">
              {{ isSaving() ? 'Updating...' : 'Update Password' }}
            </button>
          </form>
        </div>
        }

        <!-- My Companies Tab -->
        @if (activeTab() === 'companies') {
        <div class="tab-content fade-in">
          <h3>My Companies</h3>
          <p class="section-description">
            Companies you have purchased from. You can block companies to hide their products.
          </p>

          @if (myCompanies().length === 0) {
          <p class="empty-state">You haven't purchased from any companies yet.</p>
          } @else {
          <div class="company-list">
            @for (company of myCompanies(); track company.id) {
            <div class="company-item">
              <span class="company-name">{{ company.name }}</span>
              <div class="actions">
                @if (company.isBlockedByMe) {
                <span class="badge blocked">Blocked</span>
                <button class="unblock-btn" (click)="toggleBlock(company)">Unblock</button>
                } @else {
                <button class="block-btn" (click)="toggleBlock(company)">Block</button>
                }
              </div>
            </div>
            }
          </div>
          }
        </div>
        }

      </div>
    </div>
  </div>

  <!-- MOBILE VIEW -->
  <div class="mobile-view">
    <div class="mobile-header">
      <h2>Profile</h2>
      <button class="mobile-logout-btn" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i>
      </button>
    </div>

    <!-- Mobile User Card -->
    <div class="mobile-user-card">
      <div class="profile-avatar-container mobile-avatar">
        @if (authService.currentUser()?.profilePictureUrl && !imageLoadFailed()) {
        <img [src]="authService.getProfileImageUrl(authService.currentUser()?.profilePictureUrl)" alt="Profile"
          class="profile-avatar" (error)="handleImageError()">
        } @else {
        <div class="profile-avatar-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
        }
        <label for="avatar-input-mobile" class="mobile-avatar-edit-btn">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg>
        </label>
        <input type="file" id="avatar-input-mobile" (change)="onFileSelected($event)" accept="image/*"
          style="display: none;">
      </div>
      <div class="mobile-user-info">
        <h3>{{ user.firstName }} {{ user.lastName }}</h3>
        <p>{{ user.email }}</p>
      </div>
    </div>

    <!-- Mobile Tabs (Segmented Control) -->
    <div class="mobile-tabs">
      <button [class.active]="activeTab() === 'edit'" (click)="setActiveTab('edit')">Details</button>
      <button [class.active]="activeTab() === 'password'" (click)="setActiveTab('password')">Password</button>
      <button [class.active]="activeTab() === 'companies'" (click)="setActiveTab('companies')">Companies</button>
    </div>

    <!-- Mobile Content -->
    <div class="mobile-content">
      
      @if (activeTab() === 'edit') {
      <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="mobile-form">
        <div class="mobile-field">
          <label>First Name</label>
          <input type="text" formControlName="firstName" placeholder="First Name">
        </div>
        
        <div class="mobile-field">
          <label>Last Name</label>
          <input type="text" formControlName="lastName" placeholder="Last Name">
        </div>

        <div class="mobile-field">
          <label>Email</label>
          <input type="email" formControlName="email" placeholder="Email">
        </div>

        <div class="mobile-field">
          <label>Phone</label>
          <input type="tel" formControlName="phone" placeholder="Phone Number">
        </div>

        <div class="mobile-field">
          <label>Address</label>
          <textarea rows="3" formControlName="address" placeholder="Address"></textarea>
        </div>

        @if (profileForm.value.email !== user.email) {
          <div class="mobile-field highlight">
            <label>Current Password (Required)</label>
            <input type="password" formControlName="currentPassword" placeholder="Enter password to confirm">
          </div>
        }

        <button class="mobile-save-btn" type="submit" [disabled]="isSaving() || profileForm.invalid || !hasChanges">
          {{ isSaving() ? 'SAVING...' : 'SAVE CHANGES' }}
        </button>
      </form>
      }

      @if (activeTab() === 'password') {
      <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="mobile-form">
        <div class="mobile-field">
          <label>Current Password</label>
          <input type="password" formControlName="currentPassword" placeholder="Current Password">
        </div>

        <div class="mobile-field">
          <label>New Password</label>
          <div class="password-input-wrapper">
            <input type="password" formControlName="newPassword" id="newPasswordMobile" placeholder="New Password">
            <button type="button" (click)="generateRandomPassword()" class="mobile-gen-btn">GENERATE</button>
          </div>
           @if (passwordForm.get('newPassword')?.errors?.['minlength'] && passwordForm.get('newPassword')?.touched) {
            <small class="error-msg">Min {{ validationConstants.password.minLength }} chars.</small>
            }
        </div>

        <div class="mobile-field">
          <label>Confirm Password</label>
          <input type="password" formControlName="confirmNewPassword" id="confirmNewPasswordMobile" placeholder="Confirm Password">
           @if (passwordForm.errors?.['mismatch'] && passwordForm.get('confirmNewPassword')?.touched) {
            <small class="error-msg">Passwords do not match.</small>
            }
        </div>

        <button class="mobile-save-btn" type="submit" [disabled]="isSaving() || passwordForm.invalid">
          {{ isSaving() ? 'UPDATING...' : 'UPDATE PASSWORD' }}
        </button>
      </form>
      }

      @if (activeTab() === 'companies') {
        <div class="mobile-companies">
          @if (myCompanies().length === 0) {
            <p class="mobile-empty-state">No companies found.</p>
          } @else {
            @for (company of myCompanies(); track company.id) {
            <div class="mobile-company-card">
              <div class="company-info">
                <span class="name">{{ company.name }}</span>
                <span class="status" [class.blocked]="company.isBlockedByMe">
                  {{ company.isBlockedByMe ? 'Blocked' : 'Active' }}
                </span>
              </div>
              <button [class.btn-block]="!company.isBlockedByMe" [class.btn-unblock]="company.isBlockedByMe" 
                (click)="toggleBlock(company)">
                {{ company.isBlockedByMe ? 'UNBLOCK' : 'BLOCK' }}
              </button>
            </div>
            }
          }
        </div>
      }

    </div>
  </div>

  }
</div>