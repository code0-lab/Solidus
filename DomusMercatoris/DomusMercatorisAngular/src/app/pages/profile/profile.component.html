<div class="profile-container">
  <h2>My Profile</h2>
  @if (authService.currentUser(); as user) {
  <div class="profile-layout">
    <!-- Sidebar Navigation -->
    <!-- Sidebar Navigation -->
    <div class="profile-sidebar">
      <div class="user-brief">
        <div class="profile-avatar-container">
          @if (authService.currentUser()?.profilePictureUrl && !imageLoadFailed()) {
          <img [src]="authService.getProfileImageUrl(authService.currentUser()?.profilePictureUrl)" alt="Profile"
            class="profile-avatar" (error)="handleImageError()">
          } @else {
          <div class="profile-avatar-placeholder">
            ðŸ‘¤
          </div>
          }
          <div class="avatar-overlay">
            <label for="avatar-input" class="change-avatar-btn">CHANGE</label>
          </div>
          <input type="file" id="avatar-input" (change)="onFileSelected($event)" accept="image/*"
            style="display: none;">
        </div>

        <div class="user-brief-info">
          <strong>{{ user.firstName }} {{ user.lastName }}</strong>
          <span>{{ user.email }}</span>
        </div>
      </div>

      <nav class="profile-nav">
        <button [class.active]="activeTab() === 'edit'" (click)="setActiveTab('edit')">
          Edit Profile
        </button>
        <button [class.active]="activeTab() === 'password'" (click)="setActiveTab('password')">
          Change Password
        </button>
        <button class="nav-logout" (click)="logout()">
          Log Out
        </button>
      </nav>
    </div>

    <!-- Main Content Area -->
    <div class="profile-content">

      <!-- Edit Profile Tab -->
      @if (activeTab() === 'edit') {
      <div class="tab-content fade-in">
        <h3>Edit Profile</h3>
        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">

          <div class="form-row">
            <div class="field-group">
              <label for="firstName">First Name</label>
              <input id="firstName" type="text" formControlName="firstName">
            </div>
            <div class="field-group">
              <label for="lastName">Last Name</label>
              <input id="lastName" type="text" formControlName="lastName">
            </div>
          </div>

          <div class="field-group">
            <label for="email">Email Address</label>
            <input id="email" type="email" formControlName="email">
            @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
            <small class="error-msg">Please enter a valid email address.</small>
            }
          </div>

          <div class="field-group">
            <label for="phone">Phone</label>
            <input id="phone" type="tel" formControlName="phone" placeholder="Add your phone number">
            @if (profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched) {
            <small class="error-msg">Please enter a valid phone number (digits, space, +).</small>
            }
          </div>

          <div class="field-group">
            <label for="address">Address</label>
            <textarea id="address" rows="3" formControlName="address" placeholder="Add your address"></textarea>
          </div>

          <!-- Conditional Password Field if Email Changed -->
          @if (profileForm.value.email !== user.email) {
          <div class="field-group highlight-box">
            <label for="confirmPassEmail">Current Password (Required to change email)</label>
            <input id="confirmPassEmail" type="password" formControlName="currentPassword"
              placeholder="Confirm with your password">
          </div>
          }

          <button class="save-btn" type="submit" [disabled]="isSaving() || profileForm.invalid || !hasChanges">
            {{ isSaving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </form>
      </div>
      }

      <!-- Change Password Tab -->
      @if (activeTab() === 'password') {
      <div class="tab-content fade-in">
        <h3>Change Password</h3>
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
          <div class="field-group">
            <label for="currentPass">Current Password</label>
            <input id="currentPass" type="password" formControlName="currentPassword">
          </div>

          <div class="field-group">
            <label for="newPass">New Password</label>
            <input id="newPass" type="password" formControlName="newPassword">
            @if (passwordForm.get('newPassword')?.errors?.['minlength'] && passwordForm.get('newPassword')?.touched) {
            <small class="error-msg">Password must be at least 6 characters.</small>
            }
          </div>

          <div class="field-group">
            <label for="confirmPass">Confirm New Password</label>
            <input id="confirmPass" type="password" formControlName="confirmNewPassword">
            @if (passwordForm.errors?.['mismatch'] && passwordForm.get('confirmNewPassword')?.touched) {
            <small class="error-msg">Passwords do not match.</small>
            }
          </div>

          <button class="save-btn" type="submit" [disabled]="isSaving() || passwordForm.invalid">
            {{ isSaving() ? 'Updating...' : 'Update Password' }}
          </button>
        </form>
      </div>
      }

    </div>
  </div>
  }
</div>