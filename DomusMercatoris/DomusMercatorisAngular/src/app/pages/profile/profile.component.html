<div class="profile-container">
  <h2>My Profile</h2>
  @if (authService.currentUser(); as user) {
  <div class="profile-layout">
    <!-- Sidebar Navigation -->
    <!-- Sidebar Navigation -->
    <div class="profile-sidebar">
      <div class="user-brief">
        <div class="profile-avatar-container">
          @if (authService.currentUser()?.profilePictureUrl && !imageLoadFailed()) {
          <img [src]="authService.getProfileImageUrl(authService.currentUser()?.profilePictureUrl)" alt="Profile"
            class="profile-avatar" (error)="handleImageError()">
          } @else {
          <div class="profile-avatar-placeholder">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 24 24" fill="none"
              stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          }
          <div class="avatar-overlay">
            <label for="avatar-input" class="change-avatar-btn">CHANGE</label>
          </div>
          <input type="file" id="avatar-input" (change)="onFileSelected($event)" accept="image/*"
            style="display: none;">
        </div>

        <div class="user-brief-info">
          <strong>{{ user.firstName }} {{ user.lastName }}</strong>
          <span>{{ user.email }}</span>
        </div>
      </div>

      <nav class="profile-nav">
        <button [class.active]="activeTab() === 'edit'" (click)="setActiveTab('edit')">
          Edit Profile
        </button>
        <button [class.active]="activeTab() === 'password'" (click)="setActiveTab('password')">
          Change Password
        </button>
        <button [class.active]="activeTab() === 'companies'" (click)="setActiveTab('companies')">
          My Companies
        </button>
        <button class="nav-logout" (click)="logout()">
          Log Out
        </button>
      </nav>
    </div>

    <!-- Main Content Area -->
    <div class="profile-content">

      <!-- Edit Profile Tab -->
      @if (activeTab() === 'edit') {
      <div class="tab-content fade-in">
        <h3>Edit Profile</h3>
        <form [formGroup]="profileForm" (ngSubmit)="saveProfile()">

          <div class="form-row">
            <div class="field-group">
              <label for="firstName">First Name</label>
              <input id="firstName" type="text" formControlName="firstName">
            </div>
            <div class="field-group">
              <label for="lastName">Last Name</label>
              <input id="lastName" type="text" formControlName="lastName">
            </div>
          </div>

          <div class="field-group">
            <label for="email">Email Address</label>
            <input id="email" type="email" formControlName="email">
            @if (profileForm.get('email')?.invalid && profileForm.get('email')?.touched) {
            <small class="error-msg">Please enter a valid email address.</small>
            }
          </div>

          <div class="field-group">
            <label for="phone">Phone</label>
            <input id="phone" type="tel" formControlName="phone" placeholder="Add your phone number">
            @if (profileForm.get('phone')?.invalid && profileForm.get('phone')?.touched) {
            <small class="error-msg">Please enter a valid phone number (digits, space, +).</small>
            }
          </div>

          <div class="field-group">
            <label for="address">Address</label>
            <textarea id="address" rows="3" formControlName="address" placeholder="Add your address"></textarea>
          </div>

          <!-- Conditional Password Field if Email Changed -->
          @if (profileForm.value.email !== user.email) {
          <div class="field-group highlight-box">
            <label for="confirmPassEmail">Current Password (Required to change email)</label>
            <input id="confirmPassEmail" type="password" formControlName="currentPassword"
              placeholder="Confirm with your password">
          </div>
          }

          <button class="save-btn" type="submit" [disabled]="isSaving() || profileForm.invalid || !hasChanges">
            {{ isSaving() ? 'Saving...' : 'Save Changes' }}
          </button>
        </form>
      </div>
      }

      <!-- Change Password Tab -->
      @if (activeTab() === 'password') {
      <div class="tab-content fade-in">
        <h3>Change Password</h3>
        <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
          <div class="field-group">
            <label for="currentPass">Current Password</label>
            <input id="currentPass" type="password" formControlName="currentPassword">
          </div>

          <div class="field-group">
            <label for="newPass">New Password</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input id="newPassword" type="password" formControlName="newPassword" style="flex: 1;">
              <button type="button" (click)="generateRandomPassword()"
                style="padding: 0.5rem; background: #333; color: white; border: none; cursor: pointer; font-size: 0.8rem;">Generate
                Random</button>
            </div>
            @if (passwordForm.get('newPassword')?.errors?.['minlength'] && passwordForm.get('newPassword')?.touched) {
            <small class="error-msg">Password must be at least 8 characters.</small>
            }
          </div>

          <div class="field-group">
            <label for="confirmPass">Confirm New Password</label>
            <input id="confirmNewPassword" type="password" formControlName="confirmNewPassword">
            @if (passwordForm.errors?.['mismatch'] && passwordForm.get('confirmNewPassword')?.touched) {
            <small class="error-msg">Passwords do not match.</small>
            }
          </div>

          <button class="save-btn" type="submit" [disabled]="isSaving() || passwordForm.invalid">
            {{ isSaving() ? 'Updating...' : 'Update Password' }}
          </button>
        </form>
      </div>
      }

      <!-- My Companies Tab -->
      @if (activeTab() === 'companies') {
      <div class="tab-content fade-in">
        <h3>My Companies</h3>
        <p class="section-description">
          Companies you have purchased from. You can block companies to hide their products.
        </p>

        @if (myCompanies().length === 0) {
        <p class="empty-state">You haven't purchased from any companies yet.</p>
        } @else {
        <div class="company-list">
          @for (company of myCompanies(); track company.id) {
          <div class="company-item">
            <span class="company-name">{{ company.name }}</span>
            <div class="actions">
              @if (company.isBlockedByMe) {
              <span class="badge blocked">Blocked</span>
              <button class="unblock-btn" (click)="toggleBlock(company)">Unblock</button>
              } @else {
              <button class="block-btn" (click)="toggleBlock(company)">Block</button>
              }
            </div>
          </div>
          }
        </div>
        }
      </div>
      }

    </div>
  </div>
  }
</div>