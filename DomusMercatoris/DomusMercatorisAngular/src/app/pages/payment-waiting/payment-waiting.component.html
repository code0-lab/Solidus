<div class="waiting-container">
    <div class="content-box">
        <!-- Show spinner if no status OR status is for a different order -->
        <div class="spinner-container" *ngIf="!paymentService.paymentStatus() || paymentService.paymentStatus()?.orderId?.toString() !== orderId()">
            
            <ng-container *ngIf="!isTimedOut(); else timeoutTemplate">
                
                <div class="bank-notice">
                    <div class="bank-header">
                        <div class="bank-logo">S</div>
                        <div class="bank-title">Solidus Bank Secure Payment</div>
                    </div>
                    
                    <div class="bank-body">
                        <p class="greeting">Dear {{ customerName() }},</p>
                        <p class="instruction">Please use the following code to authorize your transaction.</p>
                        
                        <div class="transaction-details">
                            <div class="detail-row">
                                <span class="label">Merchant:</span>
                                <span class="value">Solidus Inc.</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Order ID:</span>
                                <span class="value">#{{ orderId() }}</span>
                            </div>
                            <div class="detail-row">
                                <span class="label">Amount:</span>
                                <span class="value highlight">{{ orderDetails()?.totalPrice | currency:'USD' }}</span>
                            </div>
                        </div>

                        <div class="code-section">
                            <label>Verification Code</label>
                            <div class="input-group">
                                <input type="text" [(ngModel)]="confirmationCode" class="code-input" placeholder="------" maxlength="6">
                                <button class="verify-btn" (click)="verifyCode()" [disabled]="!confirmationCode()">
                                    VERIFY
                                </button>
                            </div>
                            
                            <div class="reject-section">
                                <button class="reject-btn" (click)="rejectPayment()">Cancel Transaction</button>
                            </div>

                            <div class="timer-display" [class.danger]="timeLeft() < 30">
                                Code expires in: {{ formattedTime() }}
                            </div>
                        </div>
                    </div>
                    
                    <div class="bank-footer">
                        <div class="secure-icon">üîí</div>
                        <span>256-bit SSL Secure Transaction</span>
                    </div>

                    <!-- Custom Reject Modal Overlay -->
                    <div class="modal-overlay" *ngIf="showRejectModal()">
                        <div class="modal-content">
                            <div class="modal-icon">‚ö†Ô∏è</div>
                            <h3>Cancel Transaction?</h3>
                            <p>Are you sure you want to cancel this payment? This action cannot be undone.</p>
                            <div class="modal-actions">
                                <button class="btn-cancel" (click)="cancelReject()">No, Keep it</button>
                                <button class="btn-confirm" (click)="confirmReject()">Yes, Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="connection-status">
                    Status: {{ paymentService.connectionState() }}
                </div>
            </ng-container>

            <ng-template #timeoutTemplate>
                <div class="timeout-state">
                    <div class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="#F4C430" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                            <line x1="12" y1="9" x2="12" y2="13"></line>
                            <line x1="12" y1="17" x2="12.01" y2="17"></line>
                        </svg>
                    </div>
                    <h2>Session Expired</h2>
                    <p>For security reasons, this payment session has timed out.</p>
                    <button class="return-btn" routerLink="/my-orders">Return to Orders</button>
                </div>
            </ng-template>

        </div>

        <!-- Show success only if approved AND matches current order -->
        <div class="success-container" *ngIf="paymentService.paymentStatus()?.isApproved && paymentService.paymentStatus()?.orderId?.toString() === orderId()">
            <div class="checkmark">‚úÖ</div>
            <h2>Payment Approved</h2>
            <p>Your transaction has been successfully processed.</p>
        </div>

        <!-- Show error only if NOT approved AND matches current order -->
        <div class="error-container" *ngIf="paymentService.paymentStatus() && !paymentService.paymentStatus()?.isApproved && paymentService.paymentStatus()?.orderId?.toString() === orderId()">
            <div class="cross">‚ùå</div>
            <h2>Payment Declined</h2>
            <p>Please check your details and try again.</p>
        </div>
    </div>
</div>