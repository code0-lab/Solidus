<div class="modal-overlay" (click)="close()">
  <div class="modal-content modal-product" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <button class="close-btn" (click)="close()">×</button>
      <div class="modal-title-box">Product Detail</div>
    </div>
    
    <div class="product-detail-content">
      <div class="product-images" [style.background-color]="product.bg">
        @if (allImages().length > 1) {
          <button class="nav-btn prev" (click)="prevImage()">❮</button>
          <img [src]="allImages()[currentImageIndex()].url" alt="Product Image" (click)="openImageViewer(allImages()[currentImageIndex()].url)">
          <button class="nav-btn next" (click)="nextImage()">❯</button>
          
          <div class="image-indicators">
            @for (img of allImages(); track $index) {
              <div 
                class="indicator" 
                [class.active]="$index === currentImageIndex()"
                (click)="setImage($index)"
                [title]="img.variant ? img.variant.color : 'Product Image'">
              </div>
            }
          </div>
        } @else if (allImages().length === 1) {
          <img [src]="allImages()[0].url" alt="Product Image" (click)="openImageViewer(allImages()[0].url)">
        } @else {
           <!-- Fallback if no images at all -->
           <div style="height: 100%; display: flex; align-items: center; justify-content: center;">No Image</div>
        }
      </div>

      <div class="product-info">
        <div class="tabs">
          <button 
            class="tab-btn" 
            [class.active]="activeTab === 'details'"
            (click)="activeTab = 'details'">
            Details
          </button>
          <button 
            class="tab-btn" 
            [class.active]="activeTab === 'comments'"
            (click)="activeTab = 'comments'">
            Comments ({{ commentService.comments().length }})
          </button>
        </div>

        @if (activeTab === 'details') {
          <div class="tab-content">
            <app-product-detail-info 
              [product]="product" 
              [selectedVariant]="selectedVariant()"
              (variantSelected)="selectVariant($event)">
            </app-product-detail-info>
          </div>
        } @else {
          <div class="tab-content">
            <app-product-comments [productId]="product.id"></app-product-comments>
          </div>
        }
      </div>
    </div>
    @if (viewerOpen()) {
      <div class="image-viewer-overlay" (click)="closeImageViewer()">
        <div class="image-viewer-content" (click)="$event.stopPropagation()">
          <button class="close-btn" (click)="closeImageViewer()">×</button>
          <img [src]="viewerImageUrl()" alt="Full Image">
        </div>
      </div>
    }
  </div>
</div>
