<div class="search-bar-container" [class.expanded]="isExpanded" [class.dragging]="isDragging"
  (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">

  <!-- Toggle Button (Visible when NOT expanded) -->
  @if (!isExpanded) {
  <button class="search-toggle" (click)="toggleSearch()" aria-label="Open Search">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="11" cy="11" r="8"></circle>
      <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
    </svg>
  </button>
  }

  <!-- Expanded Content -->
  @if (isExpanded) {
  <div class="search-content">
    <div class="search-scope" [class.collapsed]="isTyping || isDragging">
      <!-- Full Select (Visible when NOT typing and NOT dragging) -->
      @if (!isTyping && !isDragging) {
      <select [ngModel]="productService.selectedAutoCategory()"
        (ngModelChange)="productService.selectedAutoCategory.set($event)">
        <option [ngValue]="null">All Categories</option>
        @for (cat of productService.autoCategories(); track cat.id) {
        <option [ngValue]="cat.id">{{ cat.name }}</option>
        }
      </select>
      }

      <!-- Funnel Icon (Visible ONLY when typing or dragging) -->
      @if (isTyping || isDragging) {
      <div class="scope-icon" (click)="openCategories($event)">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
        </svg>
      </div>
      }
    </div>

    <div class="search-input-wrapper">
      <input class="search" type="search" placeholder="Search or Drop Image" [(ngModel)]="query"
        (keydown.enter)="goSearch()" (focus)="onInputFocus()" (blur)="onInputBlur()" />
    </div>

    <button class="search-submit" (click)="goSearch()" aria-label="Go">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    </button>

    <button class="search-camera" type="button" (click)="openSelectDialog()" aria-label="search via photograph"
      (mouseenter)="showHint = true" (mouseleave)="showHint = false">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
      @if (showHint) {
      <span class="hint" role="tooltip">Search via photograph</span>
      }
    </button>

    <!-- Close Button -->
    <button class="search-close" (click)="toggleSearch()" aria-label="Close Search">
      âœ•
    </button>
  </div>

  <!-- Hidden File Input for Click Selection -->
  <input #fileInput type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none;" />

  <!-- Drag Overlay -->
  @if (isDragging) {
  <div class="drag-overlay">
    <span>Drop image to search</span>
  </div>
  }
  }

  @if (isClassifying) {
  <span class="status">Classifying...</span>
  }
  @if (selectedClusterId !== null) {
  <span class="status">Class: {{ selectedClusterId }}</span>
  }
  @if (classifyError) {
  <span class="status error">{{ classifyError }}</span>
  }
</div>