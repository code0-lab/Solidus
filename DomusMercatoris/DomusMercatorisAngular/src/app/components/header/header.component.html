<header class="navbar">
  <div class="navbar-top">
    <div class="brand" routerLink="/">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"
        style="margin-right: 8px;">
        <circle cx="12" cy="12" r="10" fill="white" stroke="black" stroke-width="2" />
        <circle cx="12" cy="12" r="7" stroke="black" stroke-width="1" stroke-dasharray="2 2" fill="none" />
        <text x="12" y="16.5" font-family="serif" font-size="14" text-anchor="middle" font-weight="bold"
          fill="black">S</text>
      </svg>
      Solidus
    </div>

    <div class="nav-center-desktop">
      <app-search-bar></app-search-bar>
    </div>

    <div class="nav-actions">
      <!-- Notification Bell -->
      <button class="icon" aria-label="notifications" (click)="handleNotificationsClick()" style="position: relative;">
        <!-- Bell SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        @if (unreadCount > 0) {
          <span class="cart-badge">{{ unreadCount }}</span>
        }
      </button>

      <button class="icon" aria-label="cart" (click)="handleCartClick()" style="position: relative;">
        <!-- Cart SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="9" cy="21" r="1"></circle>
          <circle cx="20" cy="21" r="1"></circle>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
        </svg>
        @if (cartService.totalCount() > 0) {
        <span class="cart-badge">{{ cartService.totalCount() }}</span>
        }
      </button>
      <button class="icon" aria-label="profile" (click)="handleProfileClick()">
        @if (authService.currentUser()) {
        @if (authService.currentUser()?.profilePictureUrl && !imageLoadFailed()) {
        <img [src]="authService.getProfileImageUrl(authService.currentUser()?.profilePictureUrl)" alt="Profile"
          class="header-avatar" (error)="handleImageError()">
        } @else {
        <!-- User Logged In SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        }
        } @else {
        <!-- User Guest SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        }
      </button>
      
      <!-- Floating Notification (Always Visible if Active and History Closed) -->
      @if (activeNotification && !isNotificationsOpen) {
        <div class="payment-notification-floating">
          <div class="notification-arrow"></div>
          <div class="notification-header">
            <div class="header-center">
              <span class="bank-icon">üèõ</span>
              <span class="bank-name">Solidus Bank</span>
            </div>
            <div class="header-right">
              <span class="time">Now</span>
              <button class="close-btn" (click)="closeNotification(activeNotification!.code, $event)">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
              </button>
            </div>
          </div>
          <div class="notification-body">
            <p class="msg-text">Transaction of <strong>{{ activeNotification!.amount | currency:'USD' }}</strong> initiated.</p>
            <p class="msg-code">Your verification code: <span class="code-box">{{ activeNotification!.code }}</span></p>
            <p class="msg-warning">‚ö†Ô∏è DO NOT SHARE THIS CODE</p>
          </div>
        </div>
      }
    </div>
  </div>

  @if (isNotificationsOpen) {
    <div class="cart-dropdown"> <!-- Reuse cart dropdown styles for consistency -->
      <div class="cart-header">
        <span>Notifications</span>
        <span class="count">{{ notifications().length }} total</span>
      </div>
      <div class="cart-items">
        @for (note of notifications(); track note.code) {
          <div class="cart-item" [style.background]="note.read ? 'white' : '#fffde7'">
            <div style="width: 100%;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="font-weight: bold; font-size: 0.9em;">Solidus Bank</span>
                <span style="font-size: 0.8em; color: #666;">{{ note.time | date:'shortTime' }}</span>
              </div>
              <div style="font-size: 0.85em;">
                Code: <strong style="font-family: monospace;">{{ note.code }}</strong> for {{ note.amount | currency:'USD' }}
              </div>
            </div>
          </div>
        }
        @if (notifications().length === 0) {
          <div class="empty" style="padding: 20px; text-align: center; color: #666;">No notifications.</div>
        }
      </div>
    </div>
  }


  @if (isCartOpen) {
  <div class="cart-dropdown">
    <div class="cart-header">
      <span>Cart</span>
      <span class="count">{{ cartService.totalCount() }} items</span>
    </div>
    <div class="cart-items">
      @for (item of cartService.items(); track item.id || (item.product.id + '_' + (item.variant ? item.variant.id : ''))) {
      <div class="cart-item" [class.highlighted-item]="cartService.highlightedItemIds().includes(item.id!)">
        <div class="title">
          {{ item.product.name }}
          @if (item.variant) {
          <span class="variant-info" style="font-size: 0.8em; color: #888;">({{ item.variant.color }})</span>
          }
        </div>
        @if (cartService.highlightedItemIds().includes(item.id!)) {
           <div class="stock-warning" style="color: red; font-size: 0.8em; margin-bottom: 4px;">
             {{ cartService.itemWarnings().get(item.id!) || 'Quantity reduced due to low stock' }}
           </div>
        }
        <div class="controls">
          <button (click)="dec(item)">-</button>
          <input type="text" 
                 class="qty-input" 
                 [ngModel]="item.qty" 
                 [ngModelOptions]="{updateOn: 'blur'}"
                 (ngModelChange)="onQtyChange(item, $event)" 
                 (keydown)="preventInvalidInput($event)"
                 (keydown.enter)="$any($event.target).blur()"
                 (paste)="onPaste($event)"
                 (blur)="onBlur(item, $event)"
                 inputmode="numeric"
                 pattern="[0-9]*">
          <button (click)="inc(item)">+</button>
          <button class="remove" (click)="remove(item)">√ó</button>
        </div>
      </div>
      }
      @if (cartService.items().length === 0) {
      <div class="empty">Your cart is empty.</div>
      }
    </div>
    <div class="cart-footer">
      <div class="total">Total: {{ cartService.totalPrice() | currency:'USD':'symbol' }}</div>
      <div class="actions" style="display: flex; gap: 10px;">
        <button class="clear" (click)="clearCart()">Clear</button>
        <button class="checkout" (click)="checkout()" style="background: black; color: white; border: none; padding: 5px 10px; cursor: pointer;">Checkout</button>
      </div>
    </div>
    
  </div>
  }

  @if (isProfileOpen && authService.currentUser()) {
  <div class="profile-dropdown">
    <div class="profile-header">
      <span class="name">{{ authService.currentUser()?.firstName }} {{ authService.currentUser()?.lastName }}</span>
      <span class="email">{{ authService.currentUser()?.email }}</span>
    </div>
    <div class="profile-menu">
      <a routerLink="/profile" (click)="closeProfile()" class="menu-item">
        My Profile
      </a>
      <a routerLink="/my-orders" (click)="closeProfile()" class="menu-item">
        My Orders
      </a>
      <div class="divider"></div>
      <button (click)="authService.logout(); closeProfile()" class="menu-item logout">
        Logout
      </button>
    </div>
  </div>
  }
</header>