@model DomusMercatoris.Core.Entities.AutoCategory
@{
    var depth = (int)ViewData["Depth"];
    var allCats = (List<DomusMercatoris.Core.Entities.AutoCategory>)ViewData["AllCats"];
    var children = allCats.Where(x => x.ParentId == Model.Id).OrderBy(x => x.Name).ToList();
    var hasChildren = children.Any();
    var padding = depth * 20;
}
<tr class="tree-row @(depth > 0 ? "d-none" : "")" 
    data-id="@Model.Id" 
    data-parent-id="@(Model.ParentId ?? 0)"
    data-depth="@depth">
    <td class="ps-3">
        <div style="padding-left: @(padding)px;" class="d-flex align-items-center">
            @if (hasChildren)
            {
                <button type="button" class="btn btn-sm btn-link p-0 me-2 text-decoration-none tree-toggle" 
                        data-target="@Model.Id" 
                        style="width: 20px; text-align: center; color: #333;">
                    <i class="bi bi-chevron-right"></i>
                </button>
            }
            else
            {
                 <span style="width: 20px; display: inline-block; text-align: center;" class="me-2 text-muted">
                    @if(depth > 0) { <i class="bi bi-dot"></i> }
                 </span>
            }
            
            <span class="fw-bold">@Model.Name</span>
            @if (!string.IsNullOrEmpty(Model.Description))
            {
                <small class="text-muted ms-2 text-truncate d-none d-sm-inline" style="max-width: 200px;">@Model.Description</small>
            }
        </div>
    </td>
    <td>
        @if (Model.ProductClusters != null && Model.ProductClusters.Any())
        {
            foreach(var cluster in Model.ProductClusters)
            {
                <span class="badge bg-info text-dark d-inline-block me-1 mb-1">
                    @cluster.Name (v@(cluster.Version))
                </span>
            }
        }
        else
        {
            <span class="badge bg-secondary">No Clusters</span>
        }
    </td>
    <td>
        <small class="text-muted">@Model.CreatedAt.ToShortDateString()</small>
    </td>
    <td class="text-end pe-3">
        <div class="btn-group btn-group-sm">
            <a href="?editId=@Model.Id" class="btn btn-outline-primary">
                <i class="bi bi-pencil"></i>
            </a>
            <form method="post" asp-page-handler="Delete" asp-route-id="@Model.Id" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this auto category?');">
                <button type="submit" class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i>
                </button>
            </form>
        </div>
    </td>
</tr>

@{
    foreach(var child in children)
    {
        var childViewData = new ViewDataDictionary(ViewData);
        childViewData["Depth"] = depth + 1;
        childViewData["AllCats"] = allCats;
        <partial name="_AutoCategoryRow" model="child" view-data="childViewData" />
    }
}
